---
title: "Prediction of Adar Editing Levels from bpRNA Structure"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
library(ggplot2)
library(randomForest)
library(gbm)
```

## load the feature matrix and split into training and test sets 
```{r load data}
set.seed(1)

#load the feature matrix 
data=read.table("rf_features.txt",header=TRUE,sep='\t')
#remove values with no NaN in editing level
data=data[is.nan(data$ave_editing_level)==FALSE,]
head(data)
```
The feature values are: 
* edit_feat -- Single character value of structure type for the edited A at position 50. One of S,H,M,I,B,X,E
* prev_feat -- The 5' structural feature upstream of edited A 
* next_feat -- The 3' structural feature downstream of edited  A 

* mp1 -- Firt mutated position along the RNA sequence 
* mref1 -- Reference allele at first mutated position 
* mtype1 -- One of "mismatch","indel","wt"
* mfeat1 -- Single character value of structure type for mutated base. One of S,H,M,I,B,X,E
* mfeat1_prev -- The 5' structural feature upstream of mutated base. 
* mfeat1_next -- The 3' structural feature downstream of mutated base. 
* adist1 -- The distance (in sequence space ) of the mutated base from the edited A. 

Repeat for possible second mutation ('None' if only 1 mutation present in sequence):
* mp2 

* mref2 

* mtype2 

* mfeat2 

* mfeat2_prev 

* mfeat2_next

* adist2 

```{r splits}
#get training and test splits; use 80% train, 20% test split  
train_indices=sample(nrow(data),0.8*nrow(data),replace=FALSE)
train_split=data[train_indices,]
test_split=data[-train_indices,]

```
#Bagging 
```{r bagging_train}
#train rf 
bag.data=randomForest(ave_editing_level~.,data=data,subset=train_indices,mtry=19,importance=TRUE)
print(bag.data)
```

## Predictions on training split 
```{r bagging_predict_train}
#get predictions on training & test data 
yhat.bag.train=predict(bag.data,newdata=train_split)
yhat.bag.test=predict(bag.data,newdata=test_split)
plot(yhat.bag.train,train_split$ave_editing_level)
abline(0,1)
print(mean((yhat.bag.train-train_split$ave_editing_level)^2))
```

## Predictions on test split 
```{r bagging_predict_test}

plot(yhat.bag.test,test_split$ave_editing_level)
abline(0,1)
print(mean((yhat.bag.test-test_split$ave_editing_level)^2))
```

##Feature Importance 
```{r bagging_feat_imp}

#get the feature importance 
importance (bag.data )
varImpPlot(bag.data)
```
The features of highest importance are distance from editing site, position of the first and second mutations. 

#Boosting 
```{r boosting}
boost.data=gbm(ave_editing_level~.,data=train_split,distribution="gaussian",n.trees=5000,interaction.depth = 4)
summary(boost.data)
```
The "mp1" and "mp2" features are the most important variables (these are the positions along the sequence of mutation 1 and 2)

```{r boosting_plot}
par(mfrow=c(1,2))
plot(boost.data,i="mp1")
plot(boost.data,i="mp2")
```
We use the boosted model to predict on the test data: 

```{r boosting_predict}
yhat.boost=predict(boost.data,newdata=test_split,n.trees=5000)
mean((yhat.boost-test_split$ave_editing_level)^2)
```
Experiment with the boosting shrinkage parameter (increase to 0.2 from default of 0.001)

```{r shrinkage}
for(shrinkage_val in c(0.005, 0.01, 0.05, 0.1, 0.2))
{
print(shrinkage_val)
boost.data=gbm(ave_editing_level~.,data=train_split,distribution="gaussian",n.trees=5000,interaction.depth=4,shrinkage=shrinkage_val,verbose=F)
yhat.boost=predict(boost.data,newdata=test_split,n.trees=5000)
print(mean((yhat.boost-test_split$ave_editing_level)^2))
}
```